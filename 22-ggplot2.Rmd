```{r echo = FALSE}
library(knitr)

# Color text
colorize <- function(x, color) {
  
  if (knitr::is_latex_output()) {
    
    sprintf("\\textcolor{%s}{%s}", color, x)
    
  } else if (knitr::is_html_output()) {
    
    sprintf("<span style='color: %s;'>%s</span>", color, x)
    
  } else { x }
}
```

# Visualizando datos: incursi칩n a ggplot2 {#ggplot2}

Una de las principales fortalezas de `R` frente a `Python` es el manejo de datos con `{tidyverse}`, entorno en el que se incluye el paquete `{ggplot2}`.

```{r}
library(tidyverse)
```

La <mark>**visualizaci칩n de datos o dataviz**</mark> deber칤a ser una parte fundamental de todo an치lisis de datos. No es solo que nuestro trabajo sea m치s **presentable y est칠tico** (algo fundamental). La visualizaci칩n de datos es <mark>**fundamental para convertir el dato en informaci칩n**</mark>, y usar dicha informaci칩n para <mark>**contar una historia**</mark> con nuestros datos: no solo importa lo que cuentas sino **c칩mo lo cuentas**. 

```{r echo = FALSE, out.width = "60%", fig.align = "center", fig.cap = "Imagen extra칤da de Reddit <https://www.reddit.com/r/lego/comments/pezxk5/oc_a_lego_data_story_adapted_from_original_image/>."}
knitr::include_graphics("./img/telling-dataviz")

```

<!---
Uno de los ejemplos m치s famosos para explicar la **importancia de la visualizaci칩n de datos** en el an치lisis exploratorio es el conocido como [**cuarteto de Anscombe**](https://cartasdelaplace.substack.com/p/carta-2): cuatro pares de datos $(X, Y)$ con la misma media de todas las $X$, la misma media de todas las $Y$, la misma correlaci칩n en todos los pares y la misma recta de regresi칩n si la pint치semos. Matem치ticamente, con dichos indicadores, no podr칤amos distinguir un conjunto de datos de otro, pero al visualizarlos, son datos totalmente distintos. Algo similar sucede con el <mark>**conjunto de datos `Datasaurus`**</mark> que te visualizo debajo de estas l칤neas, conjunto creado por el experto en visualizaci칩n de datos **Alberto Cairo**: mismas medias y varianzas, mismas correlaciones, pero datos totalmente distintos.

-->

```{r include = FALSE, eval = FALSE}
library(datasauRus)
library(glue)
library(ggthemes)
library(gganimate)
library(tidyverse)

anotaciones <- datasaurus_dozen %>% group_by(dataset) %>%
  mutate(media_x = mean(x), media_y = mean(y),
         var_x = var(x), var_y = var(y),
         cor_xy = cor(x, y),
         texto = glue("Media X = {round(media_x, 1)}
                      Varianza X = {round(var_x, 1)}
                      Media Y = {round(media_y, 1)}
                      Varianza Y = {round(var_y, 1)}
                      Corr(X, Y) = {round(cor_xy, 1)}")) %>%
  ungroup()

ggplot(datasaurus_dozen,
         # Color en funci칩n del conjunto
         aes(x = x, y = y, color = as.numeric(as.factor(dataset)))) +
  geom_point(size = 9, alpha = 0.5, show.legend = FALSE) +
  # Escala de colores en gradiente
  scale_color_gradient2_tableau("Red-Blue Diverging") +
  # Anotaciones de los c치lculos
  geom_text(data = anotaciones %>% group_by(dataset) %>% slice(1),
            aes(x = 83, y = 5, label = texto),
            color = "black", hjust = 0, vjust = -1.5,
            size = 4) +
  ggtitle("THE DATASAURUS DOZEN\n") +
  labs(subtitle =
         paste0("Gr치ficos: J. 츼lvarez Li칠bana | ",
                "Datos: Alberto Cairo")) +
  coord_cartesian(clip = "off") +
  theme(legend.position = "none") + # sin leyenda
  # Transiciones y fade-in/fade-out
  transition_states(dataset, 3, 1) + enter_fade() + exit_fade()

```


## Grammar of graphics (gg): entendiendo la gram치tica ggplot2

La idea de la filosof칤a detr치s del paquete `{ggplot2}` (ya incluido en `{tidyverse}`) es <mark>**entender los gr치ficos como parte integrada del flujo de procesamiento, depuraci칩n y modelado**</mark> de los datos, d치ndoles una gram치tica, bas치ndose en la idea de [춺The Grammar of Graphics췉 de Leland Wilkinson](https://www.amazon.es/Grammar-Graphics-Statistics-Computing/dp/0387245448). Puedes profundizar en esa idea de _Grammar of Graphics_  en las siguientes <mark>**obras de referencia del dataviz**</mark>

- [춺Gram치tica de las gr치ficas: pistas para mejorar las representaciones de datos췉 de Joaqu칤n Sevilla](https://academica-e.unavarra.es/bitstream/handle/2454/15785/Gram%C3%A1tica.pdf)
- [춺Quantitative Graphics in Statistics: A Brief History췉 de James R. Beniger y Dorothy L. Robyn. The American Statistician (1978)](https://www.jstor.org/stable/2683467)]
- [춺Presentation Graphics췉 de Leland Wilkinson. International Encyclopedia of the Social & Behavioral Sciences](https://www.cs.uic.edu/~wilkinson/Publications/iesbs.pdf)
- [춺The Visual Display of Quantitative Information췉 de E. W. Tufte](https://www.amazon.es/Visual-Display-Quantitative-Information/dp/0961392142)
- [춺The Functional Art: an introduction to information graphics and visualization췉 de Alberto Cairo](https://www.amazon.es/Functional-Art-Voices-That-Matter/dp/0321834739)

La documentaci칩n del paquete puedes consultarla en <https://ggplot2-book.org/introduction.html> y nos permitir치 <mark>**combinar**</mark> diferentes elementos gr치ficos y <mark>**ligarlos a los datos**</mark>. El objetivo es empezar con un lienzo en blanco e ir <mark>**a침adiendo capas**</mark> a tu gr치fico, como har칤as por ejemplo en Photoshop, con la diferencia de que nuestras **capas podemos ligarlas al conjunto de datos**, tanto las capas est칠ticas como las estad칤sticas. Y dicho paquete nos permite hacerlo con la misma filosof칤a con la que hemos procesado los datos


```{r grammar, echo = FALSE, out.width = "65%", fig.align = "center", fig.cap = "Idea detr치s de la 춺Grammar of graphics췉 de Wilkinson."}
knitr::include_graphics("./img/grammar.jpg")
```


La ventaja del sistema `{ggplot2}` es poder <mark>**mapear atributos est칠ticos (color, forma, tama침o) de objetos geom칠tricos (puntos, barras, l칤neas)**</mark> en funci칩n de los datos, a침adiendo transformaciones de los datos, res칰menes estad칤sticos y transformaciones de las coordenadas.


Un gr치fico se compondr치 de las **siguientes capas**

* <mark>**Datos**</mark>: nuestro gr치fico estar치 vinculado a un conjunto de datos.
* <mark>**Mapeado de elementos (aesthetics)**</mark>: ejes, color, forma, tama침o, etc (en funci칩n de los datos)
* <mark>**Elementos geom칠tricos (geom)**</mark>: puntos, l칤neas, barras, pol칤gonos, etc.
* <mark>**Componer gr치ficas (facet)**</mark>: visualizar varias gr치ficas a la vez.
* <mark>**Transformaciones estad칤sticas (stat)**</mark>: ordenar, resumir, agrupar, etc.
* <mark>**Sistema de coordenadas (coord)**</mark>: coordenadas, grids, etc.
* <mark>**Temas (theme)**</mark>: fuente, tama침o de letra, subt칤tulos, captions, leyenda, ejes, etc.

## Primer intento: scatter plot o diagrama de puntos

Veamos un primer intento para entender la filosof칤a. Imagina que queremos dibujar un _scatter plot_ o <mark>**diagrama de (dispersi칩n) de puntos**</mark>.


### Datos: gapminder

Para ello vamos a usar el conjunto de datos `gapminder`, del paquete hom칩nimo: un fichero con <mark>**datos de esperanzas de vida, poblaciones y renta per c치pita**</mark> de distintos pa칤ses en distintos momentos temporales.

```{r}
library(gapminder)
gapminder
glimpse(gapminder)
```

Para empezar con algo sencillo <mark>**filtraremos los datos de 1997**</mark> haciendo uso de `filter()`.

```{r}
gapminder_1997 <- gapminder %>% filter(year == 1997)
gapminder_1997
```

Vamos a realizar un <mark>**diagrama de puntos**</mark> enfrentando en el <mark>**eje Y**</mark> la poblaci칩n (variable `pop`) y en el <mark>**eje X**</mark> la renta per c치pita (variable `gdpPercap`). **쯈u칠 necesitamos?**

* <mark>**Datos**</mark>: el conjunto filtrado `gapminder_1997`.
* <mark>**Mapeado**</mark>: indicarle en `aes()` (<mark>**aesthetics**</mark>) las variables a pintar en cada coordenada. Todo lo que est칠 asignado dentro de `aes()` depender치 de una variable contenida en los datos. En este caso, el eje X depender치 de la variable `gdpPercap`, y el eje Y de la variable `pop`.
* <mark>**Elegir una geometr칤a**</mark>: optaremos en este primer caso por puntos.

```{r}
ggplot(gapminder_1997, aes(x = gdpPercap, y = pop)) +
  geom_point() # Geometr칤a
```


### Mapeado de elementos (aesthetics)

#### Variables de los ejes

Para profundizar en el mapeado de `aes()` vamos a hacer lo mismo pero <mark>**cambiando el rol de los ejes**</mark>, intercambiando las variables, en este caso `aes(y = gdpPercap, x = pop)`

```{r}
ggplot(gapminder_1997, aes(y = gdpPercap, x = pop)) +
  geom_point()
```

La idea podemos repetirla enfrentando ahora la <mark>**esperanza de vida en el eje X**</mark> (variable `lifeExp`) y la <mark>**renta per c치pita en el eje Y**</mark> (variable `gdpPercap`).

```{r}
ggplot(gapminder_1997, aes(y = gdpPercap, x = lifeExp)) +
  geom_point()
```

#### Colores, formas, tama침os


<mark>**쮺칩mo podemos dar color y tama침o a nuestro gr치fico?**</mark>

La opci칩n m치s sencilla es indic치ndole, dentro de `geom_point()` el color de la geometr칤a con `color = ...` (en este caso, el <mark>**color del punto**</mark>), mediante un <mark>**color fijo**</mark>, bien sea con alguno de los colores reservados que tiene `R`, bien sea con su [c칩digo hexadecimal](https://htmlcolorcodes.com/es/)

```{r}
# Color con palabra reservada
ggplot(gapminder_1997, aes(y = gdpPercap, x = lifeExp)) +
  geom_point(color = "red")

# Color en hexadecimal, de la p치gina https://htmlcolorcodes.com/es/
ggplot(gapminder_1997, aes(y = gdpPercap, x = lifeExp)) +
  geom_point(color = "#2EA2D8")
```

De la misma manera podemos indicarle el <mark>**tama침o de la geometr칤a**</mark> (en este caso del punto) con `size = ...`, incluso el <mark>**porcentaje transparencia**</mark> que queremos para un color dado con `alpha = ...` (entre 0 - transparente - y 1 - totalmente opaco).

```{r}
# Color opaco
ggplot(gapminder_1997, aes(y = gdpPercap, x = lifeExp)) +
  geom_point(color = "#A02B85", size = 4)

# alpha = 50%
ggplot(gapminder_1997, aes(y = gdpPercap, x = lifeExp)) +
  geom_point(color = "#A02B85", size = 8, alpha = 0.4)
```

Si te fijas dichos par치metros se los hemos pasado <mark>**fijos y constantes**</mark>, pero podemos <mark>**mapear en `aes()`**</mark> para que **dependan de los datos**, por ejemplo, asign치ndole un <mark>**color a cada dato en funci칩n de su continente**</mark>.

```{r}
ggplot(gapminder_1997, aes(y = gdpPercap, x = lifeExp, color = continent)) +
  geom_point(size = 4.5)
```

Podemos combinarlo con lo que hemos hecho anteriormente e indicarle adem치s que queremos el <mark>**tama침o en funci칩n de la poblaci칩n**</mark>, con cierto grado de transparencia. 

```{r}
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp, color = continent, size = pop)) +
  geom_point(alpha = 0.7)
```

En lugar de jugar con el color, tambi칠n podr칤amos a침adir las variables en funci칩n de la <mark>**forma de la geometr칤a**</mark> (en este caso la forma de los 춺puntos췉) con `shape = ...`, haci칠ndola depender de `continent` (suficientes variables podr칤amos incluir, solo con ejes + colores + tama침os + formas + transparencia, hasta 6 variables distintas).

```{r}
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp, shape = continent, size = pop)) +
  geom_point(alpha = 0.7)
```

### Scales y paletas de colores

Reflexionemos sobre el gr치fico que acabamos de hacer

```{r}
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop)) +
  geom_point(alpha = 0.7)
```

Usando los datos hemos conseguido dibujar en un <mark>**gr치fico bidimensional 4 variables**</mark> (`lifeExp` y `gdpPercap` en los ejes $(X,Y)$, `continent` como color y `pop` como tama침o de la geometr칤a) con muy pocas l칤neas de c칩digo. A veces nos puede ser m치s conveniente representar alguna de las variables en <mark>**escala logar칤tmica**</mark> (importante indicarlo en el gr치fico), lo que podemos hacer facilmente con `scale_x_log10()` y `scale_y_log10()`

```{r scale-log}
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop)) +
  geom_point(alpha = 0.7) +
  # Eje Y con escala logar칤tmica
  scale_y_log10()
```

Respecto a los colores, si te fijas `R` **ha elegido autom치ticamente la paleta** de colores pero podemos <mark>**indicarle alguna paleta**</mark> concreta de varias maneras.

La primera y m치s inmediata es indicarle los <mark>**colores manualmente**</mark>: con `scale_color_manual` le podemos indicar un vector de colores.


```{r scale-color-manual}
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop)) +
  geom_point(alpha = 0.7) +
  # Eje Y con escala logar칤tmica
  scale_y_log10() +
  # Escala manual de colores
  scale_color_manual(values = c("#A02B85", "#2DE86B", "#4FB2CA",
                                "#E8DA2D", "#E84C2D"))
```


Otra opci칩n es elegir alguna de las <mark>**paletas de colores**</mark> disponibles en el paquete `{ggthemes}`, como `scale_color_economist()`, `scale_color_excel()` o `scale_color_tableau()`.

```{r ggthemes}
library(ggthemes)

# scale_color_economist()
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop)) +
  geom_point(alpha = 0.8) +
  # Eje Y con escala logar칤tmica
  scale_y_log10() +
  scale_color_economist()

# scale_color_excel()
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop)) +
  geom_point(alpha = 0.8) +
  # Eje Y con escala logar칤tmica
  scale_y_log10() +
  scale_color_excel()

# scale_color_tableau()
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop)) +
  geom_point(alpha = 0.8) +
  # Eje Y con escala logar칤tmica
  scale_y_log10() +
  scale_color_tableau()
```

Tambi칠n existen m칰ltiples <mark>**paquetes que nos proporcionan paletas**</mark> de colores basados en <mark>**pel칤culas**</mark> (paquete `{harrypotter}` descargado desde el repositorio de Github), <mark>**p치jaros**</mark> (paquete `{Manu}`) o <mark>**cuadros**</mark> (paquete `{MetBrewer}`).

```{r eval = FALSE}
devtools::install_github(repo = "https://github.com/aljrico/harrypotter")
```

```{r harrypotter}
library(harrypotter)
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop)) +
  geom_point(alpha = 0.9) +
  scale_y_log10() +
  scale_color_hp_d(option = "gryffindor")

ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop)) +
  geom_point(alpha = 0.9) +
  scale_y_log10() +
  scale_color_hp_d(option = "hufflepuff")
```

```{r eval = FALSE}
devtools::install_github("G-Thomson/Manu")
```

```{r manu}
library(Manu)
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop)) +
  geom_point(alpha = 0.9) +
  scale_y_log10() +
  # paleta del p치jaro Takah캡 - Porphyrio hochstetteri
  scale_colour_manual(values = get_pal("Takahe"))
```

```{r eval = FALSE}
devtools::install_github("BlakeRMills/MetBrewer") 
```

```{r metbrewer}
library(MetBrewer)
MetBrewer::met.brewer("Renoir")
MetBrewer::met.brewer("Monet")
MetBrewer::met.brewer("Hokusai")

ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop)) +
  geom_point(alpha = 0.9) +
  scale_y_log10() +
  scale_colour_manual(values = met.brewer("Klimt"))
```

### Geometr칤as (geom)

Hemos jugado un poco con las formas, tama침os y colores, pero siempre ha sido un <mark>**diagrama de dispersi칩n con puntos**</mark>. Al igual que hemos usado `geom_point()`, podr칤amos usar otras geometr칤as como <mark>**l칤neas**</mark> con `geom_line()`.

```{r geom-line}
# Sin separar por continente
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp)) +
  geom_line(alpha = 0.8) +
  scale_y_log10() +
  scale_color_tableau()

# Separando por continente
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent)) +
  geom_line(alpha = 0.8) +
  scale_y_log10() +
  scale_color_tableau()
```

F칤jate que la <mark>**filosof칤a es la misma**</mark>: dado que cada elemento lo podemos tratar de forma individual, pasar de un gr치fico a otro es relativamente sencillo, sin m치s que cambiar `geom_point()` por `geom_line()`.

De la misma manera podemos dibujar un diagrama de dispersi칩n con <mark>**formas hexagonales**</mark> con `geom_hex()`. Ahora el par치metro `color` corresponder치 al cortono de la forma, y `fill` al <mark>**relleno de la misma**</mark> (f칤jate que tambi칠n cambiamos `scale_color_tableau()` por `scale_fill_tableau()`)

```{r geom-hex}
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           fill = continent, size = pop)) +
  geom_hex(alpha = 0.8) +
  scale_y_log10() + scale_fill_tableau()
```

Con `geom_tile()` tambi칠n podemos dibujar en <mark>**mosaico**</mark> (como en baldosas).

```{r geom-tile}
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop)) +
  geom_tile(alpha = 0.8) +
  scale_y_log10() +
  scale_color_tableau()
```

Por 칰ltimo, con `geom_text()` podemos hacer que en lugar de una forma geom칠trica aparezcan <mark>**textos**</mark> que tengamos en alguna variable, que la pasaremos en `aes()` por el par치metro `label` (en este caso, la variable de la que tomar치 los nombres ser치 `country`).

```{r geom-text}
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop, label = country)) +
  geom_text(alpha = 0.8) +
  scale_y_log10() +
  scale_color_tableau()
```

### Componer (facets)

Hasta ahora hemos pintado una sola gr치fica, **codificando** en colores y formas. Pero tambi칠n podemos <mark>**dividir/desagregar los gr치ficos (_facetar_) por variables**</mark>, pintando por ejemplo un **gr치fico por continente**, mostrando todos los gr치ficos a la vez pero por separado, con `facet_wrap()`.

```{r facet-wrap-1}
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp)) +
  geom_point(alpha = 0.9) +
  scale_y_log10() +
  facet_wrap(~ continent)
```

Le podemos pasar <mark>**argumentos opcionales**</mark> para indicarle el n칰mero de columnas o de filas que queremos.

```{r facet-wrap-2}
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp)) +
  geom_point(alpha = 0.9) +
  scale_y_log10() +
  facet_wrap(~ continent, nrow = 3)
```

```{r}
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp)) +
  geom_point(alpha = 0.9) +
  scale_y_log10() +
  facet_wrap(~ continent, ncol = 4)
```

De esta manera podr칤amos incluso visualizar el fichero de datos originales <mark>**incluye hasta 5 variables**</mark>: las variables `pop` y `lifeExp` en los ejes, la variable `gdpPercap` en el tama침o, la variable `continent` en el color y la variable `year` en la composici칩n de `facet_wrap()`.

```{r facet-wrap-3}
library(MetBrewer)
ggplot(gapminder,
       aes(y = lifeExp, x = pop, size = gdpPercap, color = continent)) +
  geom_point(alpha = 0.6) +
  scale_x_log10() +
  scale_colour_manual(values = met.brewer("Klimt")) +
  facet_wrap(~ year)
```

Con `facet_grid()` podemos incluso <mark>**organizar una cuadr칤cula en base a dos variables**</mark>, por ejemplo que haya una <mark>**fila por a침o**</mark> (vamos a usar la tabla original en los a침os 1952, 1972, 1982 y 2002) y una <mark>**columna por continente**</mark>.


```{r facet-grid}
ggplot(gapminder %>% filter(year %in% c(1952,  1972, 1982,  2002)),
       aes(y = gdpPercap, x = lifeExp)) +
  geom_point(alpha = 0.9) +
  scale_y_log10() +
  facet_grid(year ~ continent)
```



### Coordenadas y tema

Los <mark>**gr치ficos pueden adem치s personalizarse a침adiendo**</mark>, por ejemplo, **t칤tulos y subt칤tulos de la gr치fica** con `labs()`, asignando textos a `title`, `subtitle` y `caption`.

```{r}
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop)) +
  geom_point(alpha = 0.8) +
  # Eje Y con escala logar칤tmica
  scale_y_log10() +
  scale_color_tableau() +
  labs(title = "EJEMPLO DE SCATTERPLOT CON GGPLOT2",
       subtitle =
         "Esperanza vida vs renta per c치pita (a침o 1997)",
       caption = "Autor: Javier 츼lvarez Li칠bana | Datos: gapminder")
```

Tambi칠n podemos personalizar algunos aspectos extras, como el <mark>**t칤tulo que vamos a dar a los ejes**</mark> o el <mark>**t칤tulo de las leyendas**</mark>.

```{r}
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop)) +
  geom_point(alpha = 0.8) +
  # Eje Y con escala logar칤tmica
  scale_y_log10() +
  scale_color_tableau() +
  labs(x = "Esperanza de vida", y = "Renta per c치pita",
       color = "Continente", size = "Poblaci칩n",
       title = "EJEMPLO DE SCATTERPLOT CON GGPLOT2",
       subtitle =
         "Esperanza vida vs renta per c치pita (a침o 1997)",
       caption = "Autor: Javier 츼lvarez Li칠bana | Datos: gapminder")
```

Tambi칠n podemos <mark>**ocultar alg칰n nombre de las leyendas**</mark> (o ambos) si ya es expl칤cito de lo que se est치 hablando. Por ejemplo, vamos a indicarle que no queremos el nombre de la leyenda en continentes, haciendo `color = NULL` (la variable que codifica los continentes a `NULL`).

```{r}
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop)) +
  geom_point(alpha = 0.8) +
  # Eje Y con escala logar칤tmica
  scale_y_log10() +
  scale_color_tableau() +
  labs(x = "Esperanza de vida",
       y = "Renta per c치pita",
       color = NULL, size = "Poblaci칩n",
       title = "EJEMPLO DE SCATTERPLOT CON GGPLOT2",
       subtitle =
         "Esperanza vida vs renta per c치pita (a침o 1997)",
       caption = "Autor: Javier 츼lvarez Li칠bana | Datos: gapminder")
```


Incluso podemos <mark>**ocultar la leyenda**</mark> en s칤 de alguna de alguna de las variables con `guides(size = "none")` (en este caso, `size = "none"` nos elimina la leyenda que codifica el tama침o de los puntos).

```{r}
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop)) +
  geom_point(alpha = 0.8) +
  # Eje Y con escala logar칤tmica
  scale_y_log10() +
  scale_color_tableau() +
  guides(size = "none") +
  labs(x = "Esperanza de vida",
       y = "Renta per c치pita",
       color = NULL, size = "Poblaci칩n",
       title = "EJEMPLO DE SCATTERPLOT CON GGPLOT2",
       subtitle =
         "Esperanza vida vs renta per c치pita (a침o 1997)",
       caption = "Autor: Javier 츼lvarez Li칠bana | Datos: gapminder")
```

```{r}
ggplot(gapminder_1997,
       aes(y = gdpPercap, x = lifeExp,
           color = continent, size = pop)) +
  geom_point(alpha = 0.8) +
  # Eje Y con escala logar칤tmica
  scale_y_log10() +
  scale_color_tableau() +
  guides(size = "none", color = "none") +
  labs(x = "Esperanza de vida",
       y = "Renta per c치pita",
       color = NULL, size = "Poblaci칩n",
       title = "EJEMPLO DE SCATTERPLOT CON GGPLOT2",
       subtitle =
         "Esperanza vida vs renta per c치pita (a침o 1997)",
       caption = "Autor: Javier 츼lvarez Li칠bana | Datos: gapminder")
```




## Segundo intento: diagrama de barras

Veamos un segundo intento dibujando un <mark>**diagrama de barras**</mark>.

La forma m치s inmediata de hacerlo es haciendo uso de `geom_col()` para un <mark>**diagrama de barras vertical**</mark>, al que le pasaremos la variable `gdpPercap` a representar en el eje Y (la altura de las barras) y `year`en el eje X (tendremos una barra por a침o, con la altura del total mundial para ese a침o)

```{r}
ggplot(gapminder,
     aes(y = gdpPercap, x = year)) +
  geom_col()
```

Lo que hemos hecho con `geom_col()` es **sumar todos los valores de renta per c치pita**, de todos los pa칤ses, para cada a침o.

쮺칩mo podr칤amos dibujar, <mark>**para cada a침o, una barra para cada continente (con su suma)**</mark>?

Primero vamos a obtener los <mark>**datos agrupados por continente y a침o**</mark>.

```{r}
gapminder_por_continente <-
  gapminder %>% group_by(year, continent) %>%
  summarise(sum_gdpPercap = sum(gdpPercap))
gapminder_por_continente
```

Ser치 ese conjunto `gapminder_por_continente` el que usaremos para dibujar nuestro diagrama de barras.

```{r}
ggplot(gapminder_por_continente,
     aes(y = sum_gdpPercap, x = year,
         fill = continent)) +
  geom_col() +
  scale_fill_tableau()
```

Esta forma de dibujar las barras es lo que se conoce como <mark>**formato stack o apilado**</mark>: las barras de cada a침o las ha apilado unas **encima de otras**. Si queremos que las <mark>**barras desapiladas (por separado)**</mark> indic치ndole `position = "dodge2"` en la funci칩n `geom_col()`

```{r}
ggplot(gapminder_por_continente,
     aes(y = sum_gdpPercap, x = year,
         fill = continent)) +
  geom_col(position = "dodge2") +
  scale_fill_tableau()
```

El formato de barras apiladas nos da una informaci칩n m치s limpia en este caso pero <mark>**no permite una buena comparaci칩n**</mark> entre contienentes con valores similares, dependiendo adem치s de la renta per c치pita global (la altura de la barra total). Para <mark>**facilitar esa comparaci칩n**</mark> podemos indicarle `position = "fill"`, que har치 cada barra de igual longitud, permiti칠ndonos visualizar los datos <mark>**en relativo**</mark>.

```{r}
ggplot(gapminder_por_continente,
     aes(y = sum_gdpPercap, x = year,
         fill = continent)) +
  geom_col(position = "fill") +
  scale_fill_tableau()
```

Las barras adem치s pueden ser <mark>**horizontales**</mark>, a침adiendo `coord_flip()`. Adem치s vamos a darle un <mark>**t칤tulo y otros elementos**</mark> que hemos visto anteriormente

```{r}
ggplot(gapminder_por_continente,
     aes(y = sum_gdpPercap, x = year,
         fill = continent)) +
  geom_col() + coord_flip() +
  scale_fill_tableau() +
  labs(x = "Renta per c치pita",
       y = "A침o", color = "Continente",
       title = "EJEMPLO DE DIAGRAMA DE BARRAS CON GGPLOT2",
       subtitle =
         "Barras horizontales apiladas (agrupadas por continente y a침o)",
       caption = "Autor: Javier 츼lvarez Li칠bana | Datos: gapminder")
```



## 游닇 Ejercicios

(haz click en las flechas para ver soluciones)


<details>
  <summary>游닇<strong>Ejercicio 1</strong>: ...</summary>

```{r}
# a
```

<!-- toc -->
- Soluci칩n:

...

<!-- tocstop -->
</details>

