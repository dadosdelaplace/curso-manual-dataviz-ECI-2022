```{r echo = FALSE}
library(knitr)

# Color text
colorize <- function(x, color) {
  
  if (knitr::is_latex_output()) {
    
    sprintf("\\textcolor{%s}{%s}", color, x)
    
  } else if (knitr::is_html_output()) {
    
    sprintf("<span style='color: %s;'>%s</span>", color, x)
    
  } else { x }
}
```

# Contando los datos: rmarkdown {#rmarkdown}

:::: {.blackbox data-latex=""}

Scripts usados:

* [**primer_rmarkdown.Rmd**](https://github.com/dadosdelaplace/courses-ECI-2022/blob/main/scripts/primer_rmarkdown.Rmd): importar/exportar datos.  Ver en <https://github.com/dadosdelaplace/courses-ECI-2022/blob/main/scripts/primer_rmarkdown.Rmd>

::::

Si se tuvieran que destacar una lista **fortalezas** de `R` frente a `Python`, creo que dos estar칤an en los primeros puestos. La primera ser칤a las opciones de visualizaci칩n y procesamiento de datos (y su sencillez). Y la segunda, para m칤, es sin duda sus <mark>**opciones para generar informes**</mark>, incluso <mark>**libros, webs, apuntes y hasta diapositivas**</mark> (tienes algunos de los paquetes en la lista de recursos). Y la base de todos ellos es el paquete `{rmarkdown}`.

```{r eval = FALSE}
install.packages("rmarkdown")
```

<mark>**쮺u치l es la ventaja de generarlos desde `{rmarkdown}`?**</mark>

La m치s obvia es que, al hacerlo desde `RStudio`, puedes generar un informe o una presentaci칩n de unos datos sin salirte del entorno de programaci칩n en el que est치s trabajando: <mark>**analizar los datos, resumirlos y comunicarlos desde el mismo entorno de trabajo**</mark>. La segunda ventaja es que nos va a permitir <mark>**integrar f치cilmente c칩digo `R`**</mark>, de forma que no solo podremos integrar las salidas de nuestro trabajo sino tambi칠n el c칩digo con el que lo hemos generado.

## 쯈u칠 es R Markdown?

De forma resumida, `R Markdown` es una herramienta que nos permite crear de forma sencilla documentos (este manual que est치s leyendo est치 generado integramente con dicha herramienta) combinando:

* <mark>**Markdown**</mark>: creado en 2004 por John Gruber, y de uso libro, es un 춺lenguaje췉 que nos permite <mark>**crear contenido de una manera sencilla de escribir**</mark>, y que en todo momento mantenga un dise침o legible, permitiendo la inclusi칩n sencilla de <mark>**p치rrafos, negritas, cursivas**</mark>, etc, con algunas de las ventajas de un HTML pero sin necesidad de saber programar en 칠l. Si acostumbras a escribir en wordpress, blogs u otras plataformas, seguramente hayas escrito de esta forma (sin saberlo quiz치s).
* <mark>**Latex**</mark>: herramienta (lenguaje en realidad) para escribir <mark>**notaci칩n matem치tica**</mark> como $x^2$ o $\sqrt{x}$. Si escribes notaci칩n similar en editores de texto, seguramente sin saberlo est칠s usando ya latex. Esto nos permitir치 profundizar a칰n m치s en el contenido que mostremos.
* <mark>**C칩digo y salidas de R**</mark>: podremos no solo mostrar el paso final sino el c칩digo que has ido realizando, con cajitas de c칩digo como has podido ir comprobando a lo largo de este manual.
* <mark>**Im치genes**</mark>
* <mark>**Estilos**</mark> (css, js, etc)



Y lo mejor: todo esto se podr치 hacer solo con c칩digo `R` y alg칰n extra a tener en cuenta, produciendo <mark>**material reproducible**</mark> por el resto de la comunidad. Vamos a <mark>**crear nuestro primer informe**</mark>.

## Creando nuestro primer informe

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Creando el primer fichero .rmd', out.width = '50%'}
knitr::include_graphics("img/file_rmarkdown.jpg")
```

En la imagen anterior tienes el men칰 para crear el primero fichero con extensi칩n `.rmd` (la extensi칩n de los archivos `R Markdown`). Tras hacer click en el bot칩n `File << New File << R Markdown`, nos aparecer치 el **siguiente men칰**.

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Creando el primer fichero .rmd', out.width = '50%'}
knitr::include_graphics("img/new_rmd.jpg")
```

Como ves nos varias opciones de <mark>**formatos de salida**</mark>:

* <mark>**.pdf**</mark>
* <mark>**.html**</mark> (documento din치mico, permite la interacci칩n con el usuario, como una 춺p치gina web췉)
* <mark>**.doc**</mark> (nada recomendable)

De momento <mark>**dejaremos marcado el formato HTML**</mark> que viene por defecto, y escribiremos el t칤tulo de nuestro documento. Tras ello tendremos <mark>**nuestro archivo .Rmd**</mark> (f칤jate arriba que ya no es un script `.R` como los que hemos abierto hasta ahora)

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Creando el primer fichero .rmd', out.width = '50%'}
knitr::include_graphics("img/new_rmd.jpg")
```

Un fichero `.Rmd` se <mark>**divide b치sicamente en tres partes**</mark>

1. La cabecera (eso que tienes al inicio entre `---`)
2. Texto (que podremos mejorar con **negritas** (escrito como `**negritas**`, con doble ast칠risco al inicio y final), **cursivas** (`_cursivas_`, con barra baja al inicio y final) o destacar nombres de funciones o variables de `R` (con ``R``). Recuerda que puedes a침adir ecuaciones como $x^2$ (he escrito `$x^2$`, la ecuaci칩n entre d칩lares).
3. C칩digo `R`.

### Cabecera YAML

La <mark>**cabecera**</mark> est치n en formato `YAML`, y contiene los metadatos del documento: t칤tulo, autor, fecha, estilos (si los tuvi칠semos), etc. Para probar, vamos a cambiar la cabecera que nos ha generado por defecto de la siguiente forma:

* `Title`: "Probando Probando"
* `author`: "Se침or X"
* `date`: "11/7/2014"
* `output`: `html_document` (le indicamos el <mark>**formato de salida**</mark>, en este caso un documento `HTML`)

```{r eval = FALSE}
---
title: "Probando Probando"
author: "Se침or X"
date: "11/7/2014"
output: html_document
---
```

Tras tunear nuestra cabecera **borraremos todo lo que viene despu칠s** para empezar desde cero.

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Fichero .Rmd vac칤o, solo con la cabecera', out.width = '50%'}
knitr::include_graphics("img/rmd_vacio.jpg")
```

### Texto

Solo hay una <mark>**cosa importante a tener en cuenta**</mark> en este entorno `R Markdown`: salvo que indiquemos lo contrario, todo lo que vamos a <mark>**escribir en el documento es texto**</mark>. No c칩digo `R`. Texto plano que podremos mejorar un poco con algun detalle, pero texto.

Vamos a empezar nuestro documento escribiendo por ejemplo la siguiente frase

> Este material ha sido dise침ado como complemento y recursos de apoyo al curso de la Escuela de Invierno de la UCM titulado 춺Analizando datos, visualizando informaci칩n, contando historias췉, celebrado presencialmente del 31 de enero al 4 de febrero de 2022 (16:00 a 21:00 horas, de lunes a viernes).

Una vez que hemos escrito el textos vamos a <mark>**guardar el archivo `.Rmd`**</mark> haciendo click en el bot칩n Guardar (yo he llamado al archivo `primer_rmarkdown.Rmd`). Tras guardar el documento, <mark>**tejeremos**</mark> nuestro documento haciendo click en el <mark>**bot칩n Knit**</mark>.

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Primer informe html', out.width = '50%'}
knitr::include_graphics("img/primer_html_rmd.jpg")
```

Al 춺tejer췉 el archivo se nos habr치 generado (seguramente en una ventana al margen) un **archivo `.html`**, que podemos incluso **abrir en nuestro navegador** si hacemos click en `Open in Browser`. <mark>**Hemos creado nuestro primer informe**</mark>, obviamente vac칤o de momento. Vamos a mejorar un poco el texto haciendo lo siguiente:

* Vamos a a침adir <mark>**negrita**</mark> a la frase `curso de la Escuela de Invierno de la UCM` (poniendo `**` al inicio y al final).

* Vamos a침adir <mark>**cursiva**</mark> a la palabra `material` (poniendo `_` al inicio y al final).

* Vamos a침adir un <mark>**enlace**</mark>, <https://www.ucm.es/eci//cursoecic02-pre>, asoci치ndolo al t칤tulo `춺Analizando datos, visualizando informaci칩n, contando historias췉`. Para ello el t칤tulo lo ponemos entre corchetes y justo detr치s el enlace entre par칠ntesis `[춺Analizando datos, visualizando informaci칩n, contando historias췉](https://www.ucm.es/eci//cursoecic02-pre)`

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Tuneando nuestro primer informe html', out.width = '50%'}
knitr::include_graphics("img/rmd_2.jpg")
```

Tras hacerlo volvemos a clickar en `Knit` para tejer el informe y obtendremos la siguiente salida.

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Salida del informe html', out.width = '50%'}
knitr::include_graphics("img/html_rmd_2.jpg")
```

Tenemos palabras en cursiva, en negrita, y ahora el t칤tulo del curso es un v칤nculo a una web a la que podemos hacer click. 

### Chunks: c칩digo R

Para <mark>**a침adir c칩digo `R`**</mark> debemos crear nuestras <mark>**cajas de c칩digo llamadas _chunks_**</mark>: altos en el camino en nuestro texto _markdown_ donde podremos incluir c칩digo. Para incluir uno deber치 de ir encabezado de la siguiente forma.

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Encabezado/final del chunk', out.width = '50%'}
knitr::include_graphics("img/chunk_1.jpg")
```

Dentro de dicha cajita (que tiene ahora otro color en el documento) escribiremos <mark>**c칩digo `R`**</mark>, como lo ven칤amos haciendo hasta ahora. Vamos por ejemplo a definir dos variables y su suma de la siguiente manera, escribiendo dicho c칩digo en nuestro `.Rmd` (dentro de ese _chunk_)

```{r}
# C칩digo R
x <- 1
y <- 2
x + y
``` 

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Primer chunk', out.width = '50%'}
knitr::include_graphics("img/rmd_3.jpg")
```

Como ves dentro de esos _chunks_ puedes **comentar c칩digo** como siempre con `#` (ahora veremos que hace `#` fuera de esas cajas de c칩digo). Tras hacerlo tejemos de nuevo y obtenemos ahora un documento que tiene una caja de c칩digo y su salida, en este caso `x + y`.

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Salida del html con el primer chunk', out.width = '50%'}
knitr::include_graphics("img/html_rmd_3.jpg")
```

Somos capaces de escribir en un mismo documento texto con cierto formato, c칩digo `R` y la salida del resultado, permiti칠ndonos generar informes (ya veremos como incluir gr치ficas). De hecho, lo m치s pr치ctico para <mark>**tomar apuntes de `R`**</mark> es ir anotando lo aprendido en un archivo `.Rmd`, permiti칠ndonos incluir explicaciones a nuestros c칩digos y salidas.

Los _chunk_ de c칩digo pueden tener un <mark>**nombre o etiqueta**</mark>, de forma que podamos referenciarlos de nuevo para no repetir c칩digo. Si la etiqueta es por ejemplo `chunk-1` (no se pueden poner espacios, preferiblemente solo letras y guiones), se a침adir치 como se muestra en la imagen inferior.

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Etiquetando un chunk y recicl치ndolo', out.width = '50%'}
knitr::include_graphics("img/chunk_repe_tag.jpg")
```

As칤 queda nuestra salida: con un _chunk_ que hemos escrito y otro que no hemos tenido que escribir ya que hemos usado la etiqueta del que ya ten칤amos escrito.

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Salida tras etiquetar un chunk y recicl치ndolo', out.width = '50%'}
knitr::include_graphics("img/html_tag_chunk.jpg")
```

### Organizando el documento

Con todo incluido en el documento podemos <mark>**dividirlo en secciones y subsecciones**</mark>. Para ello usaremos la sintaxis de _markdown_, poniendo almohadillas: una `#` para secciones, `##` para subsecciones, `###` para subsubsecciones, etc. Por ejemplo, vamos a

* Hacer una secci칩n principal que sea `# Primer informe`
* Tras ello a침adiremos la parte de texto.
* Creamos una subsecci칩n que se titule `## Chunks de c칩digo` donde incluiremos los dos _chunks_ que tenemos hasta ahora.

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Secciones en el archivo .rmd', out.width = '50%'}
knitr::include_graphics("img/secciones_rmd.jpg")
```

De esta forma podemos <mark>**organizar nuestro documento en secciones y subsecciones**</mark>.

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Secciones en la salida', out.width = '50%'}
knitr::include_graphics("img/secciones_rmd.jpg")
```

Adem치s podemos incluir tras el t칤tulo (y entre llaves `{}`) etiquetas (con la almohadilla `{#etiqueta}`) para luego referenciar dichas secciones en el documento. Vamos a etiqueta `# Primer informe {#seccion-1}` y  `## Chunks de c칩digo {#chunks}`. A침adiremos una nueva secci칩n donde haremos las referencias a dichas secciones como `[Secci칩n](#seccion-1)` y `[Subsecci칩n](#chunks)`.

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Referencias a secciones y subsecciones', out.width = '50%'}
knitr::include_graphics("img/ref_rmd.jpg")
```

Tambi칠n podemos organizar nuestro c칩digo creando listas, usando `*` como 칤tems.


```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Creando 칤tems en el rmd', out.width = '50%'}
knitr::include_graphics("img/items_rmd.jpg")
```

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Salida tras crear 칤tems', out.width = '50%'}
knitr::include_graphics("img/items_html.jpg")
```

### Personalizando los chunks

No s칠 si te has fijado que <mark>**en cada chunk aparece una bot칩n de _play_**</mark>: puls치ndolo podemos tener la ejecuci칩n y salida de cada chunk en nuestro `.Rmd`, sin tener que esperar a 춺tejer췉 (con `Knit`) todo el documento para **ver lo que vamos ejecutando**.

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Ejecutar chunk a chunk', out.width = '50%'}
knitr::include_graphics("img/play_chunk.jpg")
```

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Chunk ejecutado', out.width = '50%'}
knitr::include_graphics("img/chunk_ejecutado.jpg")
```

Adem치s podemos <mark>**incluir c칩digo `R`**</mark> dentro de la l칤nea de texto. Por ejemplo, podemos definir una variable `r x <- 3` para luego mostarla como `r x` (en lugar de mostrar el texto `x` ejecuta el c칩digo `R` mostrando la variable).


```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'C칩digo inline', out.width = '50%'}
knitr::include_graphics("img/codigo_inline_rmd.jpg")
```

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Salida del c칩digo inline', out.width = '50%'}
knitr::include_graphics("img/codigo_inline_html.jpg")
```

&nbsp;

Los _chunk_ podemos <mark>**personalizarlo con algunas opciones**</mark>, pas치ndolos como argumentos dentro de las llaves `{r etiqueta, ...}`.

* `include = FALSE`: se <mark>**ejecuta el c칩digo pero no se muestra ni c칩digo ni resultados**</mark> en la salida final (pero lo que se ejecuta puede ser usado en otros _chunks_ futuros).

* `echo = FALSE`: se <mark>**ejecuta el c칩digo y se muestra el resultado pero no el c칩digo**</mark> en la salida final. 

* `eval = FALSE`: se <mark>**muestra pero no se ejecuta el c칩digo**</mark> en la salida final. 

* `message = FALSE`: se <mark>**ejecuta el c칩digo pero no se muestran los mensajes**</mark> de salida que tendr칤amos en consola (en caso de existir).

* `warning = FALSE`: se <mark>**ejecuta el c칩digo pero no se muestran los warning**</mark> que tendr칤amos en consola (en caso de existir).

* `error = TRUE`: se <mark>**ejecuta el c칩digo pero permite ejecutar el c칩digo con errores mostrando los mensajes de error**</mark> que tendr칤amos en consola (en caso de existir).

Puedes ver las diferentes salidas en el archivo [primer_rmarkdown.Rmd](https://github.com/dadosdelaplace/courses-ECI-2022/blob/main/scripts/primer_rmarkdown.Rmd) en <https://github.com/dadosdelaplace/courses-ECI-2022/blob/main/scripts/primer_rmarkdown.Rmd>.

&nbsp;

Estas opciones podemos aplicarlas _chunk_ a _chunk_ o fijar los <mark>**par치metros de forma global**</mark> con `knitr::opts_chunk$set()` (dentro de un _chunk_), pas치ndole como argumentos dichas opciones (por ejemplo, `knitr::opts_chunk$set(echo = FALSE)`).



### Variables y ecuaciones

Por 칰ltimo en este primer documento vamos a a침adir una subsecci칩n `## Variables y ecuaciones` donde a침adiremos un _chunk_ asignando la suma `x + y` a una variable `z`, escribiendo antes en texto el nombre de la variable (`z`) y la f칩rmula (`$z = x + y$`).

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Variables y ecuaciones', out.width = '50%'}
knitr::include_graphics("img/variables_rmd.jpg")
```

```{r echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = 'Salida', out.width = '50%'}
knitr::include_graphics("img/variables_html.jpg")
```


## Segundo rmarkdown


### Personalizando la cabecera

```{r}
# date: "`r Sys.Date()`"
# "`r format(Sys.time(), '%d %B %Y')`"
```


### Mostrando im치genes

### Salida en PDF

## 游끤 Pr치ctica evaluable

> Pr치ctica evaluable: iniciaci칩n a la generaci칩n de informes con rmarkdown

...

