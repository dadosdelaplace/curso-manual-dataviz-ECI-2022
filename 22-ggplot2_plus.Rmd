```{r echo = FALSE}
library(knitr)

# Color text
colorize <- function(x, color) {
  
  if (knitr::is_latex_output()) {
    
    sprintf("\\textcolor{%s}{%s}", color, x)
    
  } else if (knitr::is_html_output()) {
    
    sprintf("<span style='color: %s;'>%s</span>", color, x)
    
  } else { x }
}
```

# Profundizando en ggplot2 {#ggplot2_plus}


:::: {.blackbox data-latex=""}

Scripts usados:

* [**script22.R**](https://github.com/dadosdelaplace/courses-ECI-2022/blob/main/scripts/script22.R): profundizando en tidyverse.  Ver en <https://github.com/dadosdelaplace/courses-ECI-2022/blob/main/scripts/script22.R>
::::


```{r}
library(tidyverse)
```


## Personalizando el tema



### Datos

En est ocasi칩n vamos a usar los <mark>**datos de Netflix**</mark> proporcionados por Paula Casado en [El Arte del Dato](https://elartedeldato.com/blog/como-anadir-una-anotacion-en-ggplot/), p치gina en la que se basar치 esta visualizaci칩n: visualizaremos el n칰mero de pel칤culas y series de instituto que se han estrenado en Netflix en cada a침o.

```{r}
netflix <-
  read_csv('https://raw.githubusercontent.com/elartedeldato/datasets/main/netflix_titles.csv')
netflix
```

Los datos provienen originalmente de [Kaggle](https://www.kaggle.com/shivamb/netflix-shows), y contienen las <mark>**pel칤culas y series de Netflix**</mark> hasta enero de 2021. Para visualizar vamos a filtrar las <mark>**pel칤culas y series de instituto**</mark>, usando la funci칩n `str_detect()` (del paquete `{stringr}`), que nos devolver치 `TRUE` si detecta en la variable `description` (pas치ndola a may칰sculas) el patr칩n de texto `"HIGH SCHOOL"`.

```{r}
netflix_hs <- netflix %>%
  filter(str_detect(toupper(description), "HIGH SCHOOL"))
netflix_hs 
```

Tras dicho filtro vamos a a침adir el <mark>**a침o en el que se estren칩**</mark>, con la funci칩n `year()` de `{lubridate}`, que nos devuelve el a침o de una fecha concreta. Esa fecha concreta la vamos a construir con `mdy()`.

```{r}
library(lubridate)
mdy("August 26, 2016")
```

```{r}
netflix_final <- 
  netflix_hs %>%
  mutate(year = year(mdy(date_added))) %>%
  filter(!is.na(year))
```

Como ves en `netflix_final` hemos <mark>**eliminado**</mark> aquellos registros de los que no tengamos su a침o de estreno. 

### Diagrama de barras

Tras la depuraci칩n vamos a

* agrupar por a침o con `group_by(year)`
* contar el n칰mero de elementos en cada uno con `count()`

```{r}
netflix_resumen <- 
  netflix_final %>%
  group_by(year) %>%
  count() %>%
  ungroup()
netflix_resumen
```

Con estos datos ya estamos condiciones de poder hacer nuestro diagrama de barras.

```{r}
ggplot(netflix_resumen, aes(x = year, y = n)) +
  geom_col(fill = "red")
```

### Modificando la escala de los ejes

Si te fijas solo nos ha mostrado algunos a침os en el eje X, as칤 le vamos a indicar la <mark>**escala concreta**</mark> que queremos en dicho eje con `scale_x_continuous()`, usando el argumento `breaks` en el que le indicaremos los valores donde queremos que 춺corte췉 el eje X (los corte ser치n los a침os guardados en `netflix_resumen$year`)


```{r}
ggplot(netflix_resumen, aes(x = year, y = n)) +
  geom_col(fill = "red") +
  scale_x_continuous(breaks = netflix_resumen$year)
```
  
Cuando uno de los <mark>**ejes representa una fecha**</mark> podemos indic치rselo con `scale_x_date()`, asig치ndole en `date_breaks` el lapso temporal que queremos en las marcas (por ejemplo, `date_breaks = '1 month'`). Como ejemplo, vamos a visualizar el n칰mero de pel칤culas y series generales estrenadas en Netflix desde el 1 de julio de 2020.
  
```{r}
ggplot(netflix %>%
         mutate(date_added = mdy(date_added)) %>%
         filter(!is.na(date_added) &
                  date_added > as.Date("2020-07-01")) %>%
         group_by(date_added) %>% count(),
       aes(x = date_added, y = n)) +
  geom_col(fill = "red") +
  scale_x_date(date_breaks = '1 month') 
```


### Personalizando tema

Lo primero que vamos a hacer es <mark>**a침adir t칤tulo y otras opciones**</mark> del tema que ya conocemos.

```{r}
ggplot(netflix_resumen, aes(x = year, y = n)) +
  geom_col(fill = "red") +
  scale_x_continuous(breaks = netflix_resumen$year) +
  labs(title = "NETFLIX",
       subtitle = "Pel칤culas y series de instituto",
       caption = "Basada en El Arte del Dato (https://elartedeldato.com) | Datos: Kaggle")
```

En este caso, al ser datos de Netflix, la propia palabara de es una marca por s칤 misma, y quiz치s nos interese <mark>**usar alguna fuente de Google**</mark> para cambiar la fuente por defecto. En este caso vamos a usar la fuente de Netflix, la fuente `Bebas Neue`, y para poder usarla usaremos `font_add_google()`

```{r}
library(sysfonts)
library(showtext)
font_add_google(family = "Bebas Neue",
                name = "Bebas Neue")
showtext_auto()
```

Tras ello vamos a <mark>**personalizar totalmente nuestro tema**</mark>. Lo primero que haremos ser치 춺resetear췉 el tema que podamos tener por defecto  con `theme_void()`. Tras dicho reseteo, le indicaremos con `theme()`

* `legend.position = "none"`: sin leyenda.
* `plot.title = element_text(family = "Bebas Neue", color = "red", size = 50)`: le indicaremos la fuente, el color y el tama침o de nuestro t칤tulo.

```{r}
gg <- ggplot(netflix_resumen, aes(x = year, y = n)) +
  geom_col(fill = "red") +
  scale_x_continuous(breaks = netflix_resumen$year) +
  theme_void() +
  theme(legend.position = "none",
        plot.title = element_text(family = "Bebas Neue",
                                  color = "red", size = 80)) +
  labs(title = "NETFLIX",
       subtitle = "Pel칤culas y series de instituto",
       caption = "Basada en El Arte del Dato (https://elartedeldato.com) | Datos: Kaggle")
gg
```

Ahora el t칤tulo `"NETFLIX"` est치 en la fuente de la propia marca, lo que hace nuestro gr치fico tenga un contexto m치s all치 de la mera estad칤stica: est치 intentando comunicar algo y <mark>**llamar la atenci칩n con un esquema visual conocido**</mark>.

Tras cambiar la fuente del t칤tulo vamos a indicarle que el fondo del gr치fico sea todo negro.

```{r}
gg <- 
  gg +
  theme(panel.background = element_rect(fill = "black"),
        plot.background = element_rect(fill = "black", 
                                       color = "black"))
gg
```

Tambi칠n vamos a personalizar el grid horizontal (el que marca las alturas del eje y), indic치ndole color y tama침o.

```{r}
gg <- gg +
  theme(panel.grid.major.y =
          element_line(size = 0.1, color = "white"))
gg
```


Vamos a personalizar tambi칠n la <mark>**fuente del subt칤tulo y caption**</mark> y los textos de los ejes.

```{r}
font_add_google(family = "Permanent Marker",
                name = "Permanent Marker")
showtext_auto()
gg <- gg + 
  theme(plot.subtitle = element_text(family = "Permanent Marker",
                                     size = 21, color = "white"),
        plot.caption =  element_text(family = "Permanent Marker",
                                     color = "white", size = 19),
        axis.text = 
          element_text(size = 15, family = "Permanent Marker",
                       color = "white"))
gg
```

Por 칰ltimo vamos a darle un poco de aire <mark>**a침adiendo m치rgenes**</mark>

```{r}
gg <- gg +
  theme(plot.margin = margin(t = 4, r = 4, b = 4, l = 8, "pt"))
gg
```

Por 칰ltimo con `annotate()` podemos a침adir anotaciones al gr치fico, por ejemplo, escribiendo el mes de enero en la 칰ltima barra para remarcar que solo llega hasta enero de 2021, con una fina curva como 춺flecha췉.

```{r}
gg <- gg  +
  annotate("text", label = "(hasta enero)", 
           x = 2021, y = 11, hjust = 0.3, vjust = 0, family = "Permanent Marker", size = 5, color='white', angle = 20) +
  annotate("curve", x = 2021, y = 9, xend = 2021, yend = 5,
           color = "white")
gg
```


Hemos pasado de un gr치fico de barras cualquiera a un gr치fico que ya solo por la est칠tica nos lleva autom치ticamente a Netflix. Puedes ver m치s gr치ficas y trucos en la web de Paula Casado [**El Arte del Dato**](https://elartedeldato.com/), de donde ha salido parte de la idea de este cap칤tulo.


## Gr치ficos en coordenadas polares

춺Florence, s칠 enfermera췉, 1837. Dios no sab칤a que se anunciaba a la mujer que cambi칩 la visualizaci칩n de datos.

<mark>**Florence Nightingale**</mark> (nacida en 1820 en Toscana), tras formarse en la Kaiserswerth luterana en el cuidado de marginados, fue enviada el 21 de octubre de 1854 para mejorar las <mark>**condiciones sanitarias de los soldados brit치nicos en la guerra de Crimea (1854-1856)**</mark>.

Horrorizada, Florence observ칩 las condiciones en las que se atend칤a a los soldados heridos. De esa observaci칩n contabiliz칩 una <mark>**tasa de mortalidad de 1174 por cada 10 000 soldados**</mark>: 1023 se deb칤a a enfermedades infecciosas. A su regreso a Londres se dedic칩 a reunir estad칤sticas para demostrar que los soldados fallec칤an por las condiciones sanitarias: eran muertes evitables.

<mark>**쮺칩mo demostrar algo as칤 a tus superiores cuando era vista como una mera ni침era de enfermos?**</mark> 춺Lograr a trav칠s de los ojos lo que no somos capaces de transmitir a las mentes de los ciudadanos a trav칠s de sus o칤dos insensibles췉. A trav칠s de la visualizaci칩n de datos

Es en ese momento cuando cre칩 el famoso <mark>**diagrama de la Rosa o de 치rea polar**</mark>.


El gr치fico fue una absoluta revoluci칩n ya que permit칤a representar tres variables a la vez: 

* **tiempo** (cada gajo es un mes)
* **n췈 de muertes** (치rea del gajo)
* **causa de la muerte** (color del gajo): azules para enfermedades infecciosas, rojas para heridas, negras para otras causas.

```{r florence, echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.cap = "Gr치fico original de Florence Nightingale", out.width = '50%'}
knitr::include_graphics("img/rosa_nightingale.jpg")
```

Florence quer칤a demostrar que el enorme n췈 de bajas debidas a enfermedades infecciosas era <mark>**evitable**</mark> y as칤 lo hizo con el gr치fico de la izquierda, comparado con el de la derecha: al margen de junio de 1855, el % de muertes por enfermedades (치rea azul) descendi칩 tras sus medidas para mejorar las condiciones de los hospitales.

El 8 de febrero de 1955, The Times la describi칩 como la <mark>**춺치ngel guardi치n췉 de los hospitales**</mark>, y al finalizar la contienda, fue recibida como una hero칤na, conocida como <mark>**춺The Lady with the Lamp췉 tras un poema de H. W. Longfellow**</mark> publicado en 1857. A침os despu칠s se convirti칩 en la primera mujer en la Royal Statistical Society y renunci칩 a su puesto para crear las primeras escuelas de enfermer칤a.

&nbsp;

Vamos a intentar recrear su brillante visualizaci칩n. Los datos los podemos obtener de un paquete muy interesante con datos relacionados con eventos de la <mark>**historia de la estad칤stica y dataviz**</mark>, el paquete `{HistData}`, y el conjunto `Nightingale`

```{r}
library(HistData)
Nightingale
glimpse(Nightingale)
```

De los datos solo nos interesan las variables de fecha `Date, Month, Year` y las tasas relativas (que contienen `"rate"` en el nombre).

```{r}
datos <-
  Nightingale %>% 
  select(Date, Month, Year, contains("rate"))
datos
```

Tras la selecci칩n de variables vamos a convertir los datos a _tidy data_, pasando todos los valores de tasas e mortalidad a la misma columna `tasa`, y las causas de la muerte a una columna llamada `causa`. Adem치s renombramos las variables de fecha.

```{r}
datos <-
  datos %>%
  pivot_longer(cols = 4:6, names_to = "causa",
               values_to = "tasa") %>%
  rename(fecha = Date, mes = Month, year = Year) 
datos
```

Por 칰ltimo vamos a eliminar `".rate"` de las causas, y traducirlas a castellano, as칤 como crear una nueva variable llamada `periodo` que nos dir치 si fuese antes del 1 de marzo de 1855 o despu칠s (para recrear los gr치ficos por separado, antes y despu칠s de las intervenciones llevadas a cabo por Nightingale).

```{r}
datos <-
  datos %>%
  mutate(causa = gsub(".rate", "", causa),
         causa =
           case_when(causa == "Disease" ~ "infecciosas",
                     causa == "Wounds" ~ "heridas",
                     causa == "Other" ~ "otras",
                     TRUE ~ "otras"),
         periodo =
           factor(ifelse(fecha >= as.Date("1855-04-01"),
                            "APRIL 1855 TO MARCH 1856",
                            "APRIL 1854 TO MARCH 1855"),
                     levels = c("APRIL 1855 TO MARCH 1856",
                                "APRIL 1854 TO MARCH 1855")))
datos
```

La manera m치s inmediata de representar las tasas por causa es hacer uso de un <mark>**sencillo diagrama de barras apiladas**</mark>, cada periodo por separado, con un t칤tulo, subt칤tulo y caption.

```{r}
ggplot(datos %>%
         filter(periodo == "APRIL 1854 TO MARCH 1855"),
       aes(mes, tasa, fill = causa)) + 
  geom_col() +
  labs(fill = "Causas",
       title = "DIAGRAM OF THE CAUSES OF MORTALITY",
       subtitle = "IN THE ARMY IN THE EAST (April 1854 - March 1855)",
       caption = "Author: J. 츼lvarez Li칠bana | Data: HistData")
```


```{r}
ggplot(datos %>%
         filter(periodo == "APRIL 1855 TO MARCH 1856"),
       aes(mes, tasa, fill = causa)) + 
  geom_col() +
  labs(fill = "Causas",
       title = "DIAGRAM OF THE CAUSES OF MORTALITY",
       subtitle = "IN THE ARMY IN THE EAST (April 1855 - March 1856)",
       caption = "Author: J. 츼lvarez Li칠bana | Data: HistData")
```

Ambos periodos podemos juntarlos en una misma gr치fica con `facet_wrap()`

```{r}
ggplot(datos, aes(mes, tasa, fill = causa)) + 
  geom_col() +
  facet_wrap( ~ periodo) +
  labs(fill = "Causas",
       title = "DIAGRAM OF THE CAUSES OF MORTALITY",
       subtitle = "IN THE ARMY IN THE EAST",
       caption = "Author: J. 츼lvarez Li칠bana | Data: HistData")
```


Vamos a ir acerc치ndonos al gr치fico de Florence Nighitingale, proporcionando <mark>**colores similares a los originales para las causas de fallecimiento**</mark>

```{r}
ggplot(datos, aes(mes, tasa, fill = causa)) + 
  geom_col() +
  facet_wrap( ~ periodo)  +
  scale_fill_manual(values =
                      c("#C42536", "#5aa7d1", "#6B6B6B")) +
  labs(fill = "Causas",
       title = "DIAGRAM OF THE CAUSES OF MORTALITY",
       subtitle = "IN THE ARMY IN THE EAST",
       caption = "Author: J. 츼lvarez Li칠bana | Data: HistData")
```

Nuestros datos <mark>**abarcan dos periodos**</mark>: de abril 1854 a marzo 1855, y de abril 1855 a marzo 1856. Para tener los datos ordenados cronol칩gicamente, vamos a indicarle que el a침o ir치 desde abril a marzo, en ese orden los meses, con `fct_relevel`, del paquete `{forcats}` incluido en `{tidyverse}`.

```{r}
datos <- 
  datos %>%
  mutate(mes =
           fct_relevel(mes, "Apr", "May", "Jun", "Jul",
                       "Aug", "Sep", "Oct", "Nov", "Dec",
                       "Jan", "Feb", "Mar"))

gg <-
  ggplot(datos, aes(mes, tasa, fill = causa)) + 
  geom_col() +
  facet_wrap( ~ periodo)  +
  scale_fill_manual(values =
                      c("#C42536", "#5aa7d1", "#6B6B6B")) +
  labs(fill = "Causas",
       title = "DIAGRAM OF THE CAUSES OF MORTALITY",
       subtitle = "IN THE ARMY IN THE EAST",
       caption = "Author: J. 츼lvarez Li칠bana | Data: HistData")
gg
```

Como habr치s advertido, el gr치fico original est치 en <mark>**coordenadas polares**</mark>, coordenadas en torno a un c칤rculo. Para convertir nuestro gr치fico a coordenadas polares basta con usar `coord_polar()`. Adem치s los meses originales est치n desde julio hasta junio ordenados cronol칩gicamente.

```{r}
datos <- 
  datos %>%
  mutate(mes =
           fct_relevel(mes, "Jul", "Aug", "Sep", "Oct",
                       "Nov", "Dec", "Jan", "Feb",
                       "Mar", "Apr", "May", "Jun"))

ggplot(datos, aes(mes, tasa, fill = causa)) + 
  geom_col(width = 1) +
  coord_polar() +
  scale_fill_manual(values =
                      c("#C42536", "#5aa7d1", "#6B6B6B")) +
  facet_wrap( ~ periodo) +
  labs(fill = "Causas",
       title = "DIAGRAM OF THE CAUSES OF MORTALITY",
       subtitle = "IN THE ARMY IN THE EAST",
       caption = "Author: J. 츼lvarez Li칠bana | Data: HistData")
```

Dado que en el gr치fico original no hay marcas en el eje Y, vamos eliminar el eje Y, vamos a darle etiquetas correctas a los meses (como en el original), y vamos a cambiar la escala del eje Y con `scale_y_sqrt()` (para que las diferencias no sean tan exageradas entre un c칤rculo y otro por la escala).

```{r}
gg <- 
  ggplot(datos, aes(mes, tasa, fill = causa)) + 
  geom_col(width = 1) +
  coord_polar() +
  scale_fill_manual(values =
                      c("#C42536", "#5aa7d1", "#6B6B6B")) +
  scale_y_sqrt() +
  scale_x_discrete(labels =
                     c("JULY", "AUGUST", "SEPT.",
                       "OCTOBER", "NOVEMBER", "DECEMBER",
                       "JANUARY", "FEBRUARY", "MARCH",
                       "APRIL", "MAY", "JUNE")) +
  facet_wrap( ~ periodo) +
  labs(fill = "Causas",
       title = "DIAGRAM OF THE CAUSES OF MORTALITY",
       subtitle = "IN THE ARMY IN THE EAST",
       caption = "Author: J. 츼lvarez Li칠bana | Data: HistData") 
gg + theme(axis.title.y = element_blank(),
           axis.text.y = element_blank(),
           axis.ticks.y = element_blank())
```

Por 칰ltimo podemos personalizar el fondo, los ejes, los t칤tulos, el 치ngulo de las etiquetas de los meses, etc.

```{r}
library(sysfonts)
library(showtext)
font_add_google(family = "Roboto",
                name = "Roboto")
font_add_google(family = "Cinzel Decorative",
                name = "Cinzel Decorative")
font_add_google(family = "Quattrocento",
                name = "Quattrocento")

showtext_auto()

angulo <- seq(-20, -340, length.out = 12)
gg + theme_void() +
  theme(
    # Eje y limpio
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    # Eje x (el radial)
    axis.text.x =
      element_text(face = "bold", size = 9, angle = angulo,
                   family = "Roboto"),
    panel.grid.major.x = element_line(size = 0.01, color = "black"),
    legend.position = "bottom",
    plot.background = element_rect(fill = alpha("cornsilk", 0.5)),
    plot.title =
      element_text(hjust = 0.5, size = 21,
                   family = "Cinzel Decorative"),
    plot.subtitle =
      element_text(hjust = 0.5, size = 15,
                   family = "Cinzel Decorative"),
    plot.caption =
      element_text(size = 9, family = "Quattrocento"),
    strip.text =
      element_text(hjust = 0.5, size = 7,
                   family = "Quattrocento"),
    plot.margin = margin(t = 5, r = 7, b = 5, l = 7, "pt"))
```


## Recursos para seguir profundizando

En la web de Paula Casado [El Arte del Dato](https://elartedeldato.com/) puedes encontrar tutoriales cortos y sencillos con multitud de trucos para personalizar tus gr치ficas. En la web <https://www.r-graph-gallery.com/> tienes una colecci칩n muy completa de gr치ficos generados en `{ggplot2}` para aprender y tomar ideas.

## 游닇 Ejercicios

(haz click en las flechas para ver soluciones)

El ejercicio est치 basado en el gr치fico de [Tobias Stadler](https://tobias-stalder.netlify.app/), cuyo c칩digo original puedes encontrarlo en [Github](https://github.com/toebR/Tidy-Tuesday/blob/master/hiking/script.R), al tutorial de [Tom치s Capretto](https://tcapretto.netlify.app/) y al material en [R Graph Gallery](https://www.r-graph-gallery.com/web-circular-barplot-with-R-and-ggplot2.html).

Se ruega citar la autor칤a del gr치fico a침adiendo el siguiente `caption`

```{r}
caption_chart <- "Dataviz by Tobias Stalder\ntobias-stalder.netlify.app\nSource: TidyX Crew (Ellis Hughes, Patrick Ward)\n Data: github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-11-24/readme.md"
```

Los datos provienen originalmente de la 춺Washington Trails Association췉, con datos de sendas de senderismo en Washington. Tienes el archivo `hiking.csv` en la carpeta `DATOS`. Los datos han sido descargados desde <https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-11-24>


<details>
  <summary>游닇<strong>Ejercicio 1</strong>: carga los datos `hiking.csv` y muestra las variables.</summary>


<!-- toc -->
- Soluci칩n:

```{r}
library(tidyverse)
hike_data <- read_csv("./DATOS/hiking.csv")
hike_data 
glimpse(hike_data)
```

<!-- tocstop -->
</details>

&nbsp;

<details>
  <summary>游닇<strong>Ejercicio 2</strong>:  transforma la variable `location` para obtener la region (es la primera palabra, antes del `" -- "`. Para ello puedes usar la funci칩n `word()`, que nos permite seleccionar la palabra en칠sima de una frase, indic치ndole en `sep = ...` el separado entre palabra y palabra. Convi칠rtela a factor la nueva variable `region`.</summary>


<!-- toc -->
- Soluci칩n:

```{r}
hike_data <-
  hike_data %>%
  mutate(region = as_factor(word(location, 1, sep = " -- ")))
```

<!-- tocstop -->
</details>

&nbsp;

<details>
  <summary>游닇<strong>Ejercicio 3</strong>:  transforma la variable `length` para obtener la longitud en millas de la ruta. Est치 en formato `"12.7 miles, roundtrip"`, as칤 que puedes volver a usar la funci칩n `word()`, y pasar luego la cadena de texto a n칰mero.</summary>


<!-- toc -->
- Soluci칩n:

```{r}
hike_data <-
  hike_data %>%
  mutate(miles = as.numeric(word(length, 1)))
```

<!-- tocstop -->
</details>

&nbsp;

<details>
  <summary>游닇<strong>Ejercicio 4</strong>: calcula la longitud total (acumulada)  y la media de desnivel (`gain`), con las rutas agrupadas por la variable `region`, as칤 como el n칰mero de rutas por regi칩n. </summary>

<!-- toc -->
- Soluci칩n:

```{r}
resumen <-
  hike_data %>%
  group_by(region) %>%
  summarise(sum_miles = sum(miles),
            mean_gain = round(mean(as.numeric(gain))),
            n = n())
resumen
```

<!-- tocstop -->
</details>

&nbsp;

<details>
  <summary>游닇<strong>Ejercicio 5</strong>: dibuja un diagrama de barras con la regi칩n en el eje X, la suma de millas en el eje Y y el relleno en funci칩n del n칰mero de rutas. </summary>

<!-- toc -->
- Soluci칩n:

```{r}
ggplot(resumen,
       aes(x = region, y = sum_miles, fill = n)) +
  geom_col() +
  labs(caption = caption_chart)
```

<!-- tocstop -->
</details>

&nbsp;

<details>
  <summary>游닇<strong>Ejercicio 6</strong>: repite el ejercicio anterior pero personaliza el tema dando un t칤tulo a los ejes y una fuente de tama침o adecuada para el eje X. Usa la funci칩n `str_wrap()` para convertir los nombres de regiones en p치rrafos con salto de l칤nea, indic치ndole en `width` la anchura m치xima (no romper치 palabras a mitad).</summary>

<!-- toc -->
- Soluci칩n:

```{r}
ggplot(resumen,
       aes(x = str_wrap(region, width = 7),
           y = sum_miles, fill = n)) +
  geom_col() +
  labs(caption = caption_chart,
       fill = "N췈 de rutas",
       y = "Suma acumulada de millas",
       x = "Regi칩n") +
  theme(axis.title.x = element_text(face = "bold", size = 13),
        axis.title.y = element_text(face = "bold", size = 13),
        axis.text.x = element_text(face = "bold", size = 9),
        axis.text.y = element_text(face = "bold", size = 9))
```

<!-- tocstop -->
</details>

&nbsp;

<details>
  <summary>游닇<strong>Ejercicio 7</strong>: repite el ejercicio anterior pero usando `scale_fill_gradientn()` para dar una escala de colores continua (en forma de gradiente) con cuatro colores. Introduce en `geom_col()` una transparencia de `alpha = 0.8`</summary>

<!-- toc -->
- Soluci칩n:

```{r}
gg <- 
  ggplot(resumen,
       aes(x = str_wrap(region, width = 7),
           y = sum_miles, fill = n)) +
  geom_col(alpha = 0.8) +
  scale_fill_gradientn("Cantidad de rutas",
                       colours =
                         c("#6C5B7B", "#C06C84", "#F67280", "#F8B195")) +
  labs(caption = caption_chart,
       fill = "N췈 de rutas",
       y = "Suma acumulada de millas",
       x = "Regi칩n") +
  theme(axis.title.x = element_text(face = "bold", size = 13),
        axis.title.y = element_text(face = "bold", size = 13),
        axis.text.x = element_text(face = "bold", size = 9),
        axis.text.y = element_text(face = "bold", size = 9))
gg
```

<!-- tocstop -->
</details>

&nbsp;

<details>
  <summary>游닇<strong>Ejercicio 8</strong>: usa `geom_point()` para a침adir al gr치fico anterior la media de desnivel de las rutas. Pon por ejemplo `size = 3`, `alpha = 0.85` y `color = "gray20"`.</summary>

<!-- toc -->
- Soluci칩n:

```{r}
gg <- 
  gg +
  geom_point(aes(x = str_wrap(region, 7), y = mean_gain),
             size = 3, color = "gray20", alpha = 0.85)
gg
```

<!-- tocstop -->
</details>


&nbsp;

<details>
  <summary>游닇<strong>Ejercicio 9</strong>: usa `coord_polar()` para convertir el gr치fico anterior a coordenadas polares.</summary>

<!-- toc -->
- Soluci칩n:

```{r}
gg <- gg + coord_polar()
gg
```

<!-- tocstop -->
</details>



&nbsp;

<details>
  <summary>游닇<strong>Ejercicio 10</strong>: usa `geom_segment()` para a침adir l칤neas que vayan del centro hac칤a fuera, pasando por los puntos de desnivel. Hay que pensar que lo tuvi칠semos en vertical, indic치ndole la posici칩n inicial `x` y final `xend` del segmento (en este caso, para cada regi칩n, as칤 que `x = str_wrap(region, 7)`), y la posici칩n inicial `y = 0` e `yend` un poco m치s que el m치ximo de desnivel.</summary>

<!-- toc -->
- Soluci칩n:

```{r}
gg <- gg +
  geom_segment(aes(x = str_wrap(region, 7), y = 0,
                   xend = str_wrap(region, 7),
                   yend = max(mean_gain) * 1.2),
               linetype = "dashed", color = "gray20") 
gg
```

<!-- tocstop -->
</details>

&nbsp;

<details>
  <summary>游닇<strong>Ejercicio 11</strong>: ordena los gajos en orden ascendente con `reorder()`. </summary>

<!-- toc -->
- Soluci칩n:

```{r}
gg <- 
  ggplot(resumen,
       aes(x = reorder(str_wrap(region, width = 7), sum_miles),
           y = sum_miles, fill = n)) +
  geom_col(alpha = 0.8) +
  scale_fill_gradientn("Cantidad de rutas",
                       colours =
                         c("#6C5B7B", "#C06C84", "#F67280", "#F8B195")) +
  labs(caption = caption_chart,
       fill = "N췈 de rutas",
       y = "Suma acumulada de millas",
       x = "Regi칩n") +
  theme(axis.title.x = element_text(face = "bold", size = 10),
        axis.title.y = element_text(face = "bold", size = 10),
        axis.text.x = element_text(face = "bold", size = 7),
        axis.text.y = element_text(face = "bold", size = 7)) +
  geom_point(aes(x = reorder(str_wrap(region, 7), sum_miles),
                 y = mean_gain),
             size = 3, color = "gray20", alpha = 0.85) +
  coord_polar() +
  geom_segment(aes(x = reorder(str_wrap(region, 7), sum_miles),
                   y = 0,
                   xend = str_wrap(region, 7),
                   yend = max(mean_gain) * 1.2),
               linetype = "dashed", color = "gray20") 
gg
```

<!-- tocstop -->
</details>

&nbsp;

<details>
  <summary>游닇<strong>Ejercicio 12</strong>: con `annotate()` a침ade en uno de los gajos la indicaci칩n de que la altura hasta el punto nos indica el desnivel medio. Usaremos adem치s la fuente `"Libre Caslon Text"`, muy similar a la del gr치fico original </summary>

<!-- toc -->
- Soluci칩n:

```{r}
library(sysfonts)
library(showtext)
font_add_google(family = "Libre Caslon Text",
                name = "Libre Caslon Text")
showtext_auto()
gg <- gg +
  annotate(x = 11.2, y = 1500, label = "Desnivel medio",
           geom = "text", angle = -78, color = "gray20",
           size = 2, family = "Libre Caslon Text")
gg
```


<!-- tocstop -->
</details>


&nbsp;

<details>
  <summary>游닇<strong>Ejercicio 13</strong>: con `annotate()` a침ade en uno de los gajos la indicaci칩n de que el radio del gajo nos indica la longitud acumulada de las rutas de esa regi칩n. Usaremos adem치s la fuente `"Libre Caslon Text"`, muy similar a la del gr치fico original </summary>

<!-- toc -->
- Soluci칩n:

```{r}
library(sysfonts)
library(showtext)
font_add_google(family = "Libre Caslon Text",
                name = "Libre Caslon Text")
showtext_auto()
gg <- gg +
  annotate(x = 11, y = 3200, label = "Longitud acum.",
           geom = "text", angle = 18, color = "gray20",
           size = 2, family = "Libre Caslon Text") 
gg
```

<!-- tocstop -->
</details>


Por 칰ltimo hacemos que los gajos no empiecen del centro, y a침adimos alg칰n ajuste est칠tico m치s (ver el [post original](https://www.r-graph-gallery.com/web-circular-barplot-with-R-and-ggplot2.html))

```{r}
gg + 
  scale_y_continuous(limits = c(-1500, 3500),
                     expand = c(0, 0),
                     breaks = c(0, 1000, 2000, 3000)) +
  # Make the guide for the fill discrete
  guides(fill =
           guide_colorsteps(barwidth = 11, barheight = 0.7,
                            title.position = "top",
                            title.hjust = .5)) +
  labs(title = "Senderismo en Washington",
       caption = caption_chart) +
  theme(text = element_text(color = "gray20",
                            family = "Libre Caslon Text"),
        legend.position = "bottom",
        panel.background =
          element_rect(fill = "white", color = "white"),
        panel.grid = element_blank(),
        panel.grid.major.x = element_blank())
```


 
